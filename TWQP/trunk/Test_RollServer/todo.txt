预定义：

. 一个 服务 相当于 一张 桌子
. 服务的多份实例会被客户端看到一个 桌子列表，客户端可以选择进入
. 至少要等到两个客户端进入才能开始游戏
. 游戏中可以不停的进入客户端（未到达上限的情况下）
. 服务的不同阶段进入的客户端，处于不同状态（下面详细描述）


服务阶段性状态：

. 等待客户端进入	（这个阶段进入的客户端，可以收到 “请准备”，即：处于 “正在玩” 状态）
	此阶段设定时间为 10 秒钟
	
. 等待客户端准备 （这个阶段进入的客户端，不会收到 “请准备”，但会收到 “请看成绩”，即：处于 “观战中” 状态）
	此阶段设定时间为 30 秒钟
	
. 游戏进行中		（同上）
	此阶段设定时间为 30 秒钟

. 游戏完成（本阶段不需要存在，等同于 等待客户端准备，直接跳到那个阶段）



互动流程：

. 服务等待一定数量客户端进入
	. 客户端通过代理，向游戏服务发：“请求进入”，并记录超时时间
	. 服务判断情况（比如检查当前人数上限，客户端是否有资格进入等）
		回应：“请进”，并记录 “编号，代理，超时” 等信息以占位
		回应：“不能进” 的情况在服务器端不作后续处理
	. 客户端收到 “请进” 后，界面转入具体游戏，之后向游戏服务发起 “已进入” 
		收到 “不能进” 就提示进入失败或相关信息
	. 服务收到 “已进入” 后，判断该客户端是否存在于发起进入请求的客户端列表中
		如果存在，则向客户端发 “请准备”，并记录超时时间
		如果不存在，则无视
	. 客户端收到 “请准备” 的后，界面须表现出让用户 “准备” 的样子
		并且，根据超时时间，有个被踢出服务的 “准备” 倒计时
. 服务等待所有客户端 “已准备”
	. 客户端通过用户操作向服务发起 “已准备”
	. 服务收到 “已准备”：检查玩家列表，如果发现玩家不存在，回应：准备超时，已被踢
		客户端界面应该是做出诸如关闭游戏界面，返回大厅并提示：长时间未 Ready 被踢之类的内容
. 服务等到所有客户端都 “已准备”, 游戏开始
	
. 服务向客户端发 “请投掷” ，并记录超时时间
	. 客户端收到 “请投掷” 后，界面表现大概是显示 请投骰子之类
	. 客户端向服务发送 “已投掷” ，并等待服务器公布结果
. 服务在超时时限内收到 “已投掷”，为该客户端产生随机点数
	. 如果超时未收到，则直接为超时客户端产生随机点数
	. 如果超时产生结果后才收到 “已投掷”，忽略
. 服务判断所有客户端均投掷过骰子后，
	. 系统统计结果表附在 “请看结果” 后面并发送，
		置玩家状态为 已进入，记录 “请准备” 的超时
	. 客户端收到 “请看结果” 后，显示相关信息，并进入等待客户端 “准备” 形态




上述流程的消息指令提取：

C要求进入
S请进入, S不能进入
C已进入
S请准备
C已准备好
S请投掷
C已投掷
S请看成绩（等同于 S请准备）

S请离开 （踢人）
C请核实 （断线重连后要回用户状态）





服务端超时处理：

阶段：服务回应 “请进入” 后，客户端发起 “已进入” 超时
办法：踢掉该客户端
	
阶段：服务发起 “请准备” 后，客户端回应 “已准备” 超时
办法：踢掉该客户端

阶段：服务发起 “请投掷”，客户端回应 “已投掷” 超时
办法：令该客户端自动投掷，进入下一阶段

阶段：服务发起 "请看成绩" 后，客户端回应 “已准备” 超时
办法：踢掉该客户端


客户端超时处理：（未完成）

阶段：客户端发起 “要求进入”，服务回应 “请进入” 超时
办法：

阶段：客户端发起 “已进入”，服务回应 “请准备” 超时
办法：

阶段：客户端发起 “已准备”，服务回应 “请投掷” 超时
办法：

阶段：客户端发起 “已投掷”，服务回应 “请看成绩” 超时
办法：


事件处理：（未完成）

服务端踢人：
客户端主动退出：
客户端断线退出：
客户端重新进入（恢复断线前的状态）：



异常处理：（未完成）

. 客户端 ready 之前断开
. 客户端 ready 之后断开
. 客户端于游戏开始之后断开
. 客户端掷骰子后断开
. 客户端收到成绩通告后断开

. 和客户端相连的代理异常断开（可能发生于上面任何时机）


综上所述：（未完成）

客户端具备
	游戏运行状态：正在玩，观战中
	
服务具备
	游戏运行阶段：等进入，等准备，游戏中



斗地主平台
server
消息类型:byte[][]
收到的消息包含如下数据:
byte[0]表示玩家ID
byte[1]表示动作
byte[2]表示附带数据
收到消息的同时也得到发送消息的代理ID

发送消息包含如下数据:
byte[0]表示玩家ID
byte[1]表示动作
byte[2]表示附带数据
发送的消息直接发送给代理,由代理转发给客户端.



client
消息类型 byte[][]

收到的消息包含如下数据:
byte[0]表示动作
byte[1]表示附带数据

发送消息同上
消息直接发送给分配给client的Proxy.


proxy
消息类型 byte[][]
收到的消息包含如下数据
byte[0]表示动作
byte[1]表示附带数据

收到消息的同时也得到发送消息的玩家ID

发送消息到ServerID,ServerID通过玩家的消息获取
byte[0]玩家ID
byte[1]表示动作
byte[2]表示附带数据


GameMain
消息类型 byte[][]

收到消息包含如下数据:
byte[0]玩家ID
byte[1]动作
byte[2]附带数据
(发送方(代理)ID)

发送消息
byte[0]玩家ID
byte[1]动作
byte[2]附带数据
(发送目标为发送方代理ID)


ID规划

1-99 = 代理
100-199 = 大厅  暂时使用 150
200-299 = 游戏服务
1000-?为玩家



代理的指责:
转发数据个给大厅,数据里包含玩家ID和自己的ID(大厅收到消息时知道发送方的ID)


大厅:
有三个集合,玩家、桌子、游戏服务
玩家包含属性"桌子",存储玩家所在的桌子ID,包含属性"代理",存储和玩家通讯的代理ID
桌子包含属性"游戏服务"存储桌子绑定的游戏服务ID
桌子包含属性"玩家",为int[]
	0
1		2

玩家的代理ID属性通过代理和桌子的第一次通讯获得绑定.
玩家的"桌子"ID通过玩家选择桌子消息绑定.
如果一个玩家在已经和一个代理ID绑定后,大厅通过另外一个代理ID收到了该玩家的消息,则修正该玩家的代理ID.
断开处理:
如果断开的玩家没有开始游戏,直接把移走
如果已经开始游戏,则"代打"至本局结束.

如果玩家在游戏进行时又重新连上了,把当前该玩家的数据发送给玩家.让玩家还原当前对局.



游戏服务
有一个"大厅"属性,接收到大厅的请求,绑定相应的大厅ID.当收到其他大厅发来的消息时,拒绝.这样可以保证有多个大厅服务时,每个游戏服务只被一个大厅使用.